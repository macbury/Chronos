$.notice=function(a){$.extend({title:"",description:"",icon:"",callback:function(){}},a);var c=(window.webkitNotifications!=null);if(c&&window.webkitNotifications.checkPermission()==0){var b=window.webkitNotifications.createNotification(a.icon,a.title,a.description);b.onclose=a.callback;b.show()}};$(function(){App.Models.Album=Backbone.Model.extend({url:"/albums",toJSON:function(){return{album:_.clone(this.attributes)}},})});$(function(){App.Models.Event=Backbone.Model.extend({url:"/events",start_date:new Date(),end_date:new Date(),title:"",description:"",where:"",start_date:function(){var a=new Date(this.get("start_date"));var b=$.datepicker.formatDate("d MM yy",a);b+=" "+a.getHours()+":"+a.getMinutes();return b},toJSON:function(){return{event:_.clone(this.attributes)}},validate:function(a){if(!Validate.size(a.title,5,255)){return"Musisz podać nazwę wydarzenia, musi ona mieć minimalnie 5 znaków a maksymalnie 255"}if(!Validate.size(a.description,5,1024)){return"Musisz podać opis wydarzenia, musi ona mieć minimalnie 5 znaków a maksymalnie 1024"}if(!Validate.size(a.where,5,255)){return"Musisz podać miejsce wydarzenia, musi ona mieć minimalnie 5 znaków a maksymalnie 255"}}})});$(function(){App.Models.Link=Backbone.Model.extend({type:function(){return parseInt(this.get("status_type"))},pending:function(){return this.type()==App.Models.Link.Pending},working:function(){return this.type()==App.Models.Link.Working},success:function(){return this.type()==App.Models.Link.Success},error:function(){return this.type()==App.Models.Link.Error},failure:function(){return this.type()==App.Models.Link.Failure},});App.Models.Link.Pending=0;App.Models.Link.Working=1;App.Models.Link.Success=2;App.Models.Link.Error=3;App.Models.Link.Failure=4});$(function(){App.Models.Reaction=Backbone.Model.extend({})});$(function(){App.Models.SocialAccount=Backbone.Model.extend({})});$(function(){App.Models.Status=Backbone.Model.extend({url:"/statuses",body:"",toJSON:function(){return{status:_.clone(this.attributes)}},validate:function(a){if(a.body==null){return"Treść wpisu musi być podana!"}if(a.body.length>App.Models.Status.MaxMessageLength){return"Treść wpisu nie może być większe od "+App.Models.Status.MaxMessageLength+" znaków!"}if(a.body.length<5){return"Treść wpisu nie może być mniejsza niż 5 znaków!"}}});App.Models.Status.MaxMessageLength=140});$(function(){App.Models.Stream=Backbone.Model.extend({url:"/streams",initialize:function(){_.bindAll(this,"attachStreamable","attachLinks");this.links=new App.Collections.Links();this.reactions=new App.Collections.Reactions();this.bind("change:streamable",this.attachStreamable);this.bind("change:id",this.attachLinks);this.bind("change",this.attachStreamable);this.bind("change",this.attachLinks);this.attachStreamable();this.attachLinks()},attachLinks:function(){this.url="/streams/"+this.get("id");this.links.url="/streams/"+this.get("id")+"/links";this.reactions.url="/streams/"+this.get("id")+"/reactions"},attachStreamable:function(){if(this.get("streamable_type")){this.streamable=new App.Models[this.get("streamable_type")](this.get("streamable"))}},isStatus:function(){return(this.get("streamable_type")=="Status")},progress:function(){var a=this.links.done().length*100/this.links.length;return Math.min(a,100)}})});$(function(){App.Models.Update=Backbone.Model.extend({})});$(function(){App.Collections.Links=Backbone.Collection.extend({model:App.Models.Link,downloaded:false,download:function(){if(this.length==0&&!this.downloaded){this.downloaded=true;this.fetch()}},done:function(){return this.filter(function(a){return a.success()})},remaining:function(){return this.without.apply(this,this.done())},})});$(function(){App.Collections.Reactions=Backbone.Collection.extend({model:App.Models.Reaction,downloaded:false,comparator:function(a){var b=new Date(a.get("created_at"));return b*-1},download:function(){if(this.length==0&&!this.downloaded){this.downloaded=true;this.fetch()}},})});$(function(){App.Collections.SocialAccounts=Backbone.Collection.extend({model:App.Models.SocialAccount,url:"/social_accounts"})});$(function(){App.Collections.Stream=Backbone.Collection.extend({model:App.Models.Stream,url:"/streams",fetched:false,initialize:function(){_.bindAll(this,"fetchOnce")},fetchOnce:function(){if(!this.fetched){this.fetch();this.fetched=true}}})});var AuthController={init:function(b){var c=$("#auth_process");if(c.size()==0){return false}var a=this;client.subscribe("/"+$("meta[name=auth_token]").attr("content")+"/"+c.attr("data-id")+"/auth",function(d){var d=jQuery.parseJSON(d);a.process(d)})},process:function(a){$(".progress_status img").hide();$("#auth_progress").show();$("#auth_progress .progress").animate({width:a.progress+"%"});if(a.status){$("#status_message").text(a.status)}else{if(a.error){$("#status_message").text(a.error);$("#status_message").addClass("error");setTimeout(function(){window.location.href=$("#auth_process").attr("data-redirect_to")},5000)}else{if(a.success){$("#status_message").text(a.success);setTimeout(function(){window.location.href=$("#auth_process").attr("data-redirect_to")},5000)}}}}};var DashboardController={init:function(){var a=this;client.subscribe("/"+$("meta[name=auth_token]").attr("content")+"/notifications/links",function(b){var b=jQuery.parseJSON(b);a.linkUpdateNotification(b)});this.bindCharts();this.bindViews()},bindCharts:function(){$(".view_tab").bind("chart",function(){var b=$(this).attr("data-id");var a=$(this);$.ajax({url:"/updates/"+b+"/chart",type:"GET",dataType:"JSON",success:function(c){c=JSON.parse(c);$.plot(a.find(".chart .content"),c,{xaxis:{mode:"time"},series:{lines:{show:true},points:{show:true}},legend:{backgroundColor:"#0a0909",labelBoxBorderColor:"#fff"},grid:{hoverable:true,clickable:true},});a.find(".chart .content").bind("plothover",function(g,i,f){if(f){var e=f.dataIndex+":"+f.seriesIndex;if(previousPoint!=e){previousPoint=e;$("#tooltip").remove();var d=f.datapoint[0],h=f.datapoint[1];showTooltip(f.pageX,f.pageY,f.series.label+": "+h)}}else{$("#tooltip").remove();previousPoint=null}})},})})},bindViews:function(){$(".views a").live("click",function(){var b=$(this).parents(".views").find("a");var a=$(this).parents(".views").attr("data-id");b.removeClass("selected");$.each(b,function(){var c=$(this).attr("href");$(c).hide()});$("#show_"+a).show();$($(this).attr("href")).trigger($($(this).attr("href")).attr("trigger:action"));$($(this).attr("href")).show();$(this).addClass("selected");return false});$(".show_button").live("click",function(){var a=$(this).attr("data-id");var b=$("#update_"+a).find(".views a");b.removeClass("selected");$.each(b,function(){var c=$(this).attr("href");$(c).hide()});$(this).hide();return false});$(".views:first .urls").click()},linkUpdateNotification:function(d){var c=d.link;var a=$("#link_"+c.id);var b=a.find(".text");if(a.size()==0){return false}else{a.attr("class",[a.attr("data-type"),"status_"+c.status_type].join(" "))}},};$(function(){App.Controllers.Dashboard=Backbone.Controller.extend({dashboardView:null,preload:function(){App.Storage.Streams.fetchOnce()},view:function(){if(this.dashboardView==null){this.dashboardView=new App.Views.Dashboard()}return this.dashboardView},show:function(){this.preload();this.view().render();this.view().detailsView.selectStream();this.view().streamListView.selectStream(this.view().detailsView.model)},index:function(){this.preload();this.view().render()},initialize:function(){_.bindAll(this,"index","view","show","preload");App.Storage.Streams=new App.Collections.Stream();App.Storage.Streams.comparator=function(b){var a=new Date(b.get("created_at"));return a*-1};App.Router.match("/streams/:id",{as:"stream",callback:this.show});App.Router.root(this.index)}})});$(function(){App.Controllers.SocialAccounts=Backbone.Controller.extend({social_accounts_view:null,view:function(){if(this.social_accounts_view==null){this.social_accounts_view=new App.Views.SocialAccounts()}return this.social_accounts_view},show:function(){var b=App.Storage.SocialAccounts.get(params.id);if(b){var a=new App.Views.SocialAccount({model:b});a.render()}else{redirect_to(social_accounts_path())}},index:function(){this.view().render()},basic_auth:function(){},initialize:function(){_.bindAll(this,"index","view","show","basic_auth");App.Storage.SocialAccounts=new App.Collections.SocialAccounts();App.Router.match("/accounts",{as:"social_accounts",callback:this.index});App.Router.match("/accounts/:id",{as:"social_account",callback:this.show});App.Router.match("/accounts/auth/:provider",{as:"basic_auth",callback:this.basic_auth});App.Router.match("/accounts/facebook",{as:"facebook_social_account",callback:function(){}})}})});window.error=function(b,a,d){var c=$(Haml.render(JST.error_dialog,{locals:{message:a}}));c.dialog({title:b,modal:true,width:320,show:"puff",hide:"fade",resizable:false,close:function(){$(c).remove();d()},buttons:{OK:function(){$(this).dialog("close")}}})};function tabClass(b,a){if(b==a){return"active"}else{return"normal"}}String.prototype.truncate=function(b){var a=this.substring(0,b);if(this.length>b){a=a+"..."}return a};String.prototype.strip_tags=function(){return this.replace(/<\/?[^>]+(>|$)/g,"")};$(function(){App.Views.Auth=Backbone.View.extend({el:"#auth_process",events:{},initialize:function(){var a=this;App.Faye.subscribe("/"+$("meta[name=auth_token]").attr("content")+"/"+$(this.el).attr("data-id")+"/auth",function(b){var b=jQuery.parseJSON(b);a.update(b)})},update:function(b){var a=$(this.el).attr("data-redirect_to");$(".progress",this.el).animate({width:b.progress+"%"});if(b.status){$("#status_message",this.el).text(b.status)}else{if(b.error){$("#status_message",this.el).text(b.error);$("#status_message",this.el).addClass("error");setTimeout(function(){window.location.href=a},5000)}else{if(b.success){$("#status_message",this.el).text(b.success);setTimeout(function(){window.location.href=a},5000)}}}}})});$(function(){App.Views.Dashboard=Backbone.View.extend({el:"body",streamListView:null,detailsView:null,selectedStream:null,initialize:function(){_.bindAll(this,"render");App.Storage.Streams.bind("refresh",this.render);var a=this;this.streamListView=new App.Views.StreamList();this.detailsView=new App.Views.StreamDetails()},render:function(){this.$("#workspace").html(Haml.render(JST.dashboard,{locals:{}}));$(this.el).find("#stream").html(this.streamListView.render().el);$(this.el).find("#details").html(this.detailsView.render().el);return this},})});$(function(){App.Views.Menu=Backbone.View.extend({el:".menu",events:{"click .status":"newStatus","click .event":"newEvent","click #notification_permission":"changeNotificationPermission"},newPhoto:function(){var a=new App.Views.UploadPhoto();a.render();return false},newStatus:function(){var a=new App.Views.NewStatus({model:new App.Models.Status()});a.render();return false},newEvent:function(){var a=new App.Views.NewEvent({model:new App.Models.Event()});a.render();return false},initialize:function(){_.bindAll(this,"render","newStatus","newEvent","newPhoto","changeNotificationPermission");var a=new App.Views.UploadPhoto();this.notificationsView=new App.Views.Notifications();this.render()},changeNotificationPermission:function(){window.webkitNotifications.requestPermission(function(){$.notice({title:"Chronos",description:"Będziesz teraz dostawał powiadomienia na pulpicie!"})})},render:function(){var a=this;a.notificationsView.render();this.$(".dropdown").click(function(){var c=$(this).hasClass("selected");a.$(".dropdown").removeClass("selected");a.$(".dropdown_menu").hide();if(!c){$(this).addClass("selected");$(this).parents("li").find(".dropdown_menu").show()}else{$(this).removeClass("selected")}return false});this.$(".dropdown_menu a").click(function(){$(this).parents("li").find(".dropdown").removeClass("selected");$(this).parents(".dropdown_menu").hide()});var b=(window.webkitNotifications!=null);if(b){if(window.webkitNotifications.checkPermission()>0){this.$("#notification_permission").removeAttr("checked")}else{this.$("#notification_permission").attr("checked","checked")}}return this},})});$(function(){App.Views.NewEvent=Backbone.View.extend({tagName:"div",textProcessInterval:null,events:{},initialize:function(){_.bindAll(this,"render","remove","add");var a=this;this.model.bind("error",function(b,c){$(a.el).dialog("close");error("Nie można dodać wpisu!",c,function(){$(a.el).dialog("open")})})},add:function(){var a=this;var c={title:$(this.el).find(".name").val(),where:$(this.el).find(".where").val(),start_date:$(this.el).find(".start_date").val(),end_date:$(this.el).find(".end_date").val(),description:$(this.el).find(".description").val(),image:$(this.el).find("#flyaer_image_input").val(),};var b=this.model.set(c);if(b){App.Storage.Streams.fetchOnce();this.model.save(c,{success:function(){var d=a.model.attributes.stream;d.streamable=a.model.attributes;App.Storage.Streams.add([d]);redirect_to(stream_path({id:d.id}))},});$(this.el).dialog("close")}},remove:function(){},render:function(){var a=this;$(this.el).empty();$(this.el).html(Haml.render(JST.new_event,{locals:{event:this.model}}));$(this.el).dialog({title:"Nowe wydarzenie",autoOpen:false,show:"fade",hide:"fade",width:870,resizable:false,modal:true,close:this.remove,buttons:{Publikuj:this.add,Anuluj:function(){$(this).dialog("close")}}});$(this.el).find(".start_date, .end_date").datetimepicker({stepMinute:30,});a.$("#flayer_progress").hide();a.$("#flayer_upload").show();var b=new qq.FileUploaderBasic({button:this.$("#flayer_upload")[0],multiple:false,debug:true,action:"/data",onSubmit:function(d,c){a.$("#flayer_upload").hide();a.$("#flayer_progress").show()},onProgress:function(g,f,d,e){var c=Math.round(d*100/e);a.$("#flayer_progress .progressbar .progress").animate({width:c+"%"})},onComplete:function(e,d,c){a.$("#flayer_progress").hide();a.$("#flayer_upload").show();a.$(".flyaer img").attr("src",c.file);a.$("#flyaer_image_input").val(c.file_name)},});$(this.el).dialog("open");return this},})});$(function(){App.Views.NewStatus=Backbone.View.extend({tagName:"div",textProcessInterval:null,events:{},initialize:function(){_.bindAll(this,"render","remove","textProcess","startTimer","stopTimer","add");var a=this;this.model.bind("error",function(b,c){$(a.el).dialog("close");error("Nie można dodać wpisu!",c,function(){$(a.el).dialog("open");a.startTimer()})})},add:function(){var a=this;var c={body:$(this.el).find(".status_body").val()};var b=this.model.set(c);if(b){App.Storage.Streams.fetchOnce();this.model.save(c,{success:function(){var d=a.model.attributes.stream;d.streamable=a.model.attributes;App.Storage.Streams.add([d]);redirect_to(stream_path({id:d.id}))},});$(this.el).dialog("close")}},remove:function(){this.stopTimer()},startTimer:function(){this.stopTimer();this.textProcessInterval=setTimeout(this.textProcess,100)},stopTimer:function(){clearTimeout(this.textProcessInterval);this.textProcessInterval=null},textProcess:function(){var f=/(https?:\/\/[^\>\<\s\"]+)( |\n|\t)/ig;var a=$(this.el).find(".status_body");var e=a.val().match(f);var d=new RegExp(window.location.host,"ig");var c=true;this.stopTimer();var b=this;if(e){_.each(e,function(g){if(g.match(d)==null){c=false;$.post("/redirect",{url:g},function(i){var h=a.val();h=h.replace(g,i.link+" ");a.val(h);b.startTimer()})}})}$(this.el).parents(".ui-dialog").find(".chars_count").text(App.Models.Status.MaxMessageLength-a.val().length);if(c){this.startTimer()}},render:function(){$(this.el).empty();$(this.el).html(Haml.render(JST.new_status,{locals:{}}));$(this.el).dialog({title:"Nowy wpis",autoOpen:false,show:"fade",hide:"fade",width:490,resizable:false,height:252,modal:true,close:this.remove,buttons:{Publikuj:this.add,Anuluj:function(){$(this).dialog("close")}}});$(this.el).parents(".ui-dialog").find(".ui-dialog-buttonpane").append("<div class='chars_count'>140</div>");this.startTimer();$(this.el).dialog("open");return this},})});$(function(){App.Views.NotificationPermission=Backbone.View.extend({tagName:"div",initialize:function(){_.bindAll(this,"render");var a=(window.webkitNotifications!=null);if(a&&window.webkitNotifications.checkPermission()>0){this.render()}},render:function(){var a=this;return this},})});$(function(){App.Views.Notifications=Backbone.View.extend({el:".dropdown_menu.notifications",events:{},initialize:function(){_.bindAll(this,"render","add");var a=this;this.reactions=new App.Collections.Reactions();this.reactions.url="/reactions";this.reactions.bind("refresh",this.render);this.reactions.bind("add",this.render);this.reactions.fetch();App.Faye.subscribe("/"+$("meta[name=auth_token]").attr("content")+"/notifications",function(b){var b=jQuery.parseJSON(b);a.reactions.add(b);$.notice({title:"Chronos",description:b.message})})},add:function(a){},render:function(){var a=this;this.$(".list").empty();if(this.reactions.length>0){this.$(".list").html(Haml.render(JST.notifications,{locals:{notifications:this.reactions.models}}))}else{this.$(".list").html("<p class='empty'>Brak notyfikacji</p>")}return this}})});$(function(){App.Views.SocialAccount=Backbone.View.extend({el:"body",initialize:function(){_.bindAll(this,"render","process");this.model.bind("change",this.render);$.get("/streams/"+this.model.get("id")+"/chart",this.process)},process:function(a){this.data=a;this.render()},render:function(){this.$("#workspace").html(Haml.render(JST.social_account,{locals:{account:this.model}}));if(this.data!=null){this.$("#stats").append("<div class='chart' />");this.$(".chart").append("<div class='content' />");$.plot(this.$(".chart .content"),this.data,{xaxis:{mode:"time"},series:{lines:{show:true},points:{show:true}},legend:{backgroundColor:"#0a0909",labelBoxBorderColor:"#fff"},grid:{hoverable:true,clickable:true},})}else{this.$("#stats").append("<div class='please_wait'>Wczytywanie danych...</div>")}return this},})});$(function(){App.Views.SocialAccounts=Backbone.View.extend({el:"body",initialize:function(){_.bindAll(this,"render");App.Storage.SocialAccounts.bind("refresh",this.render);App.Storage.SocialAccounts.bind("change",this.render);App.Storage.SocialAccounts.bind("add",this.render)},render:function(){this.$("#workspace").html(Haml.render(JST.social_accounts,{locals:{providers:App.Storage.Providers,accounts:App.Storage.SocialAccounts.models}}));this.$(".navigation.features li:even").addClass("alt");this.$("#providers a").click(function(){if($(this).attr("data-basic_auth")=="true"){view=new App.Views.BasicAuth();view.provider=$(this).attr("data-provider");view.render();return false}});return this},})});$(function(){App.Views.BasicAuth=Backbone.View.extend({tagName:"div",provider:null,events:{"click .login_box .submit":"login","click .button.close":"remove"},initialize:function(){_.bindAll(this,"render","remove","add","login","update")},update:function(a){this.$(".progress_status img").hide();this.$(".progressbar").show();this.$(".progress").animate({width:a.progress+"%"});if(a.status){this.$("#status_message").text(a.status)}else{if(a.error){this.$("#status_message").text(a.error);this.$("#status_message").addClass("error");this.$(".button.close").show()}else{if(a.success){this.$("#status_message").text(a.success);this.$(".button.close").show();App.Storage.SocialAccounts.fetch()}}}},login:function(){var a=this;this.$(".login_box").hide();this.$("#auth_process").show();$.ajax({url:"/auth/"+this.provider,type:"POST",data:this.$("form").serialize(),dataType:"JSON",success:function(b){var b=jQuery.parseJSON(b);a.model=new App.Models.SocialAccount(b);App.Faye.subscribe("/"+$("meta[name=auth_token]").attr("content")+"/"+b.id+"/auth",function(c){var c=jQuery.parseJSON(c);a.update(c)})}});return false},add:function(){},remove:function(){$(this.el).dialog("close")},render:function(){var a=this;$(this.el).empty();$(this.el).html(Haml.render(JST.basic_auth,{}));$(this.el).dialog({title:"Logowanie do serwisu:",autoOpen:false,show:"fade",hide:"fade",width:480,resizable:false,modal:true,});$(this.el).dialog("open");return this},})});$(function(){App.Views.StreamDetails=Backbone.View.extend({tagName:"div",loading:false,template:null,tab:"links",selectStream:function(){this.linksView=null;this.reactionsView=null;this.statsView=null;this.tab="links";if(_.include(["links","reactions","stats"],params.tab)){this.tab=params.tab}this.model=this.streamDetailsCache.get(params.id);var a=this;if(this.model==null){this.model=new App.Models.Stream({id:params.id});this.loading=true;this.model.fetch({success:function(){try{a.streamDetailsCache.add(a.model)}catch(b){console.log(b)}a.loading=false;a.render()},error:function(){a.model=null;a.loading=false;a.render()}})}this.model.bind("change",this.render);this.render()},initialize:function(){_.bindAll(this,"render","selectStream","resize","tabView");var a=this;this.streamDetailsCache=new App.Collections.Stream();this.template=JST.stream_details;App.Faye.subscribe("/"+$("meta[name=auth_token]").attr("content")+"/notifications/links",function(c){var c=jQuery.parseJSON(c);var b=a.streamDetailsCache.get(c.stream_id);if(b!=null){if(b.links.length==0){b.links.download()}else{b.links.get(c.id).set(c)}}});this.render()},streamTemplate:function(){var a="stream_"+this.model.get("streamable_type").toLowerCase();return JST[a]},tabView:function(){var a=null;if(this.tab=="links"){if(this.linksView==null){this.linksView=new App.Views.Links({model:this.model});this.model.links.fetch()}a=this.linksView}else{if(this.tab=="reactions"){if(this.reactionsView==null){this.reactionsView=new App.Views.Reactions({model:this.model});this.model.reactions.fetch()}a=this.reactionsView}else{if(this.tab=="stats"){if(this.statsView==null){this.statsView=new App.Views.Stats({model:this.model})}a=this.statsView}}}return a},resize:function(){this.$(".block, .empty").height($(window).height()-80);this.$(".details > .scroller").height(this.$(".details").height()-this.$(".details > .header").height()-17)},render:function(){$(this.el).empty();if(this.loading){$(this.el).append("<div class='empty loading'></div> ")}else{if(this.model==null){$(this.el).append("<div class='empty'>Nic nie zaznaczono...<div>")}else{var a=Haml.render(this.streamTemplate(),{locals:{stream:this.model}});$(this.el).html(Haml.render(this.template,{locals:{stream:this.model,stream_partial:a,tab:this.tab}}));$(this.el).find("abbr").attr("title",this.model.get("created_at"));$(this.el).find("abbr").timeago();this.$(".scroller").empty().append(this.tabView().el)}}this.resize();return this},})});$(function(){App.Views.Link=Backbone.View.extend({tagName:"li",events:{},initialize:function(){_.bindAll(this,"render","refresh","canvas","render_progress");this.model.bind("refresh",this.render);this.model.bind("change",this.refresh)},refresh:function(){$(this.el).html(Haml.render(JST.stream_links,{locals:{link:this.model}}));this.render_progress()},canvas:function(){return this.$("canvas")[0].getContext("2d")},render_progress:function(){var b=this.model.get("progress");if(b>0){b=b/100}var a=this.canvas();a.save();a.clearRect(0,0,32,32);a.translate(16,16);a.scale(2,2);a.rotate(-Math.PI/2);a.lineWidth=2;a.lineCap="square";a.save();a.strokeStyle="#121212";a.beginPath();a.arc(0,0,4,0,(Math.PI*2),false);a.stroke();a.restore();a.save();a.strokeStyle="#D7D7D7";a.beginPath();a.arc(0,0,4,0,b*(Math.PI*2),false);a.stroke();a.restore()},render:function(){$(this.el).html(Haml.render(JST.stream_links,{locals:{link:this.model}}));$(this.el).addClass(this.model.get("social_account").type_name).attr("id","stream_link_"+this.model.get("id"));this.render_progress();return this},})});$(function(){App.Views.Links=Backbone.View.extend({tagName:"ul",events:{},initialize:function(){_.bindAll(this,"render","addOne");this.model.links.bind("refresh",this.render);this.render()},addOne:function(a){var b=new App.Views.Link({model:a});$(b.render().el).appendTo(this.el)},render:function(){$(this.el).empty();if(this.model.links.length>0){$(this.el).addClass("links").removeClass("list");this.model.links.each(this.addOne);$(this.el).find("li:even").addClass("alt")}else{$(this.el).addClass("list");$(this.el).html("<li class='please_wait'>Wczytywanie danych...</li>")}return this},})});$(function(){App.Views.Reactions=Backbone.View.extend({tagName:"ul",events:{},initialize:function(){_.bindAll(this,"render","addOne");this.model.reactions.bind("refresh",this.render);this.render()},addOne:function(b){var a=new App.Views.Reaction({model:b});$(a.render().el).appendTo(this.el)},render:function(){$(this.el).empty();$(this.el).addClass("list");if(this.model.reactions.length==0){$(this.el).append("<li class='please_wait'>Brak reakcji...</li>")}else{this.model.reactions.each(this.addOne)}return this},})});$(function(){App.Views.Reaction=Backbone.View.extend({tagName:"li",events:{},initialize:function(){_.bindAll(this,"render");this.model.bind("refresh",this.render);this.model.bind("change",this.render)},render:function(){$(this.el).html(Haml.render(JST.stream_reaction,{locals:{reaction:this.model}}));$(this.el).addClass(this.model.get("social_account").type_name).attr("id","stream_link_"+this.model.get("id"));return this},})});$(function(){App.Views.Stats=Backbone.View.extend({tagName:"div",data:null,events:{"click .destro":"destroy",},initialize:function(){_.bindAll(this,"render","process","destroy");$.get("/streams/"+this.model.get("id")+"/chart",this.process);this.render()},destroy:function(){this.model.destroy();redirect_to(social_accounts());return false},process:function(a){this.data=a;this.render()},render:function(){$(this.el).empty();if(this.data!=null){$(this.el).append("<div class='chart' />");$(this.el).find(".chart").append("<div class='content' />");$.plot($(this.el).find(".chart .content"),this.data,{xaxis:{mode:"time"},series:{lines:{show:true},points:{show:true}},legend:{backgroundColor:"#0a0909",labelBoxBorderColor:"#fff"},grid:{hoverable:true,clickable:true},})}else{$(this.el).append("<div class='please_wait'>Wczytywanie danych...</div>")}return this},})});$(function(){App.Views.Stream=Backbone.View.extend({tagName:"li",linksView:null,reactionsView:null,statsView:null,initialize:function(){_.bindAll(this,"render","refresh","template");this.model.bind("change",this.refresh);this.model.links.bind("change",this.refresh);this.model.links.bind("refresh",this.refresh);this.model.view=this},refresh:function(){if(this.el==null){this.render()}},selectedLinks:function(){if(this.linksView==null){this.linksView=new App.Views.Links({model:this.model});this.model.links.fetch()}$(this.el).find(".tab").empty().append(this.linksView.el).show()},selectedReactions:function(){if(this.reactionsView==null){this.reactionsView=new App.Views.Reactions({model:this.model})}$(this.el).find(".tab").empty().append(this.reactionsView.el).show()},selectedStats:function(){if(this.statsView==null){this.statsView=new App.Views.Stats({model:this.model})}$(this.el).find(".tab").empty().append(this.statsView.el).show()},onTabChange:function(d){var b=$(d.target);var c=$(this.el).find(".views").find("a");$(this.el).find(".views").addClass("inTab");c.removeClass("selected");b.addClass("selected");return false},template:function(){var a="stream_"+this.model.get("streamable_type").toLowerCase();return JST[a]},render:function(){var a=Haml.render(this.template(),{locals:{stream:this.model}});$(this.el).addClass("update").addClass(this.model.get("streamable_type").toLowerCase()).attr("id","stream_"+this.model.get("id")).html(Haml.render(JST.stream,{locals:{stream_partial:a,stream:this.model}}));$(this.el).find("abbr").attr("title",this.model.get("created_at"));$(this.el).find("abbr").timeago();return this},})});$(function(){App.Views.StreamList=Backbone.View.extend({tagName:"ul",selectedStream:null,currentPage:1,events:{"click .button":"nextPage"},initialize:function(){_.bindAll(this,"addOne","addNew","render","selectStream","nextPage");App.Storage.Streams.bind("refresh",this.render);App.Storage.Streams.bind("add",this.render)},nextPage:function(){this.currentPage++;$.getJSON("/streams?page="+this.currentPage,function(a){App.Storage.Streams.add(a)});console.log(this.currentPage);return false},addNew:function(b){var a=new App.Views.Stream({model:b});$(this.el).prepend(a.render().el);$(this.el).find(".update").removeClass("alt");$(this.el).find(".update:even").addClass("alt");this.$(".empty").remove()},addOne:function(c){var b=new App.Views.Stream({model:c});var a=$(b.render().el);if(this.selectedStream&&this.selectedStream.get("id")==c.get("id")){a.addClass("selected")}$(this.el).append(a)},selectStream:function(a){this.selectedStream=a;this.$(".update").removeClass("selected");this.$("#stream_"+a.get("id")).addClass("selected")},render:function(){$(this.el).empty();if(App.Storage.Streams==null){$(this.el).append("<li class='empty'>Prosze czekać... Trwa wczytywanie danych...</li>")}else{if(App.Storage.Streams.length==0){$(this.el).append("<li class='empty'>Aktualnie nie masz dodanych żadnych wpisów!</li>")}else{App.Storage.Streams.each(this.addOne);$(this.el).find(".update").removeClass("alt");$(this.el).find(".update:even").addClass("alt");if(App.Storage.Streams.length>=10){$(this.el).append("<li class='loading'><button class='button load_more'>Wczytaj więcej</button></li>")}$(this.el).find(".load_more").click(this.nextPage)}}return this},})});$(function(){App.Views.UploadPhoto=Backbone.View.extend({tagName:"div",uploader:null,files:{},uploaded_files:[],done_files:0,initialize:function(b){_.bindAll(this,"render","progress","complete","done","close","add","addButton");var a=this;this.uploader=new qq.FileUploaderBasic({button:$(".menu .photo")[0],multiple:true,maxConnections:3,action:"/data",allowedExtensions:["png","jpg","jpeg"],onSubmit:function(d,c){a.files[d]={loaded:0,total:0};a.done_files=0;a.render()},onComplete:this.complete,onProgress:this.progress})},progress:function(d,c,a,b){this.files[d]={loaded:a,total:b}},close:function(){this.files={}},addButton:function(){return $(this.el).parents(".ui-dialog").find(".ui-dialog-buttonset button:first")},done:function(){return Math.round(this.done_files*100/_.size(this.files))},complete:function(d,c,b){this.done_files+=1;var a=$("<input type='hidden' name='album[raw_photos][]' />");a.val(b.file_name);this.$("form").append(a);this.refresh()},refresh:function(){this.addButton().attr("disabled","disabled");this.$("#upload_progress").text("Wysyłano "+this.done_files+" z "+_.size(this.files)+" zdjęć");this.$(".progressbar .progress").css({width:this.done()+"%"},"fast");if(this.done()==100){this.addButton().removeAttr("disabled")}},add:function(){var a=this;$.ajax({url:"/albums.json",data:this.$("form").serialize(),dataType:"json",type:"post",success:function(b){App.Storage.Streams.fetch({success:function(){redirect_to(stream_path({id:b.stream.id}))}})},error:function(d){var c=jQuery.parseJSON(d.response);var b=_.map(c,function(f,e){return"<p>"+e+": "+f+"</p>"}).join("\n");error("Nie można dodać albumu!",b,function(){$(a.el).dialog("open")})}});$(this.el).dialog("close")},render:function(){var a=this;$(this.el).empty();$(this.el).html(Haml.render(JST.new_photo,{}));$(this.el).dialog({title:"Zdjęcia",autoOpen:false,show:"fade",width:530,resizable:false,modal:true,close:this.close,buttons:{"Utwórz album":this.add,Anuluj:function(){$(a.el).dialog("close")}}});this.$("form").submit(function(){return false});this.refresh();$(this.el).dialog("open");return this},})});var previousPoint=null;function showTooltip(a,c,b){$('<div id="tooltip" class="tooltip">'+b+"</div>").css({position:"absolute",display:"none",top:c+5,left:a+5,}).appendTo("body").fadeIn(200)}var client=null;var auth_token=0;$(document).ready(function(){App.Router=new Router();if(window.Faye){App.Faye=new Faye.Client($("meta[name=notifications_server]").attr("content"),{timeout:60})}else{window.error("Błąd połączenia!!!","Nie można się połączyć z serwerem! Odśwież stronę lub spróbuj później.",function(){window.location.reload()})}for(var a in App.Controllers){window[a]=new App.Controllers[a]()}window.menuView=new App.Views.Menu();App.Router.run()});(function(){window.JST=window.JST||{};window.JST.basic_auth=('%form.login_box  %p    %label Login    %br/    %input#login{ type: "text", name: "login" }  %p    %label Hasło    %br/    %input#password{ type: "password", name: "password" }  %p    %button.button.submit Zaloguj się    albo    %a.button.close Anuluj#auth_process  .progress_status    %p#status_message Prosze czekać... Nie odświeżaj strony!!!!!!!!!!!    %img{ src: "/images/big_ajax.gif" }    .clear    .progressbar      .progress    %button.button.close Zamknij');window.JST.dashboard=("#stream  .empty.loading#details  .empty Nic nie zaznaczono....clear");window.JST.error_dialog=('%div  %p    %span.ui-icon.ui-icon-circle-close{ style: "float:left; margin:0 7px 50px 0;" }    = message');window.JST.new_event=('%form.new_event  .column.left    %p      %label Nazwa wydarzenia      %br/      %input.name{ type: "text" }    %p      %label Start      %br/      %input.start_date{ type: "text" }    %p      %label Koniec      %br/      %input.end_date{ type: "text" }    %p      %label Gdzie      %br/      %input.where{ type: "text" }  .column.middle    %p      %label Opis      %br/      %textarea.description{ type: "text" }  .column.right    .flyaer      %input{ type: "hidden", name: "image", id: "flyaer_image_input" }      %img{ src: "/images/flyear_medium.png" }      .upload#flayer_upload Zmień zdjęcie dla wydarzenia      .upload#flayer_progress        .progressbar          .progress  .clear');window.JST.new_photo=('%form.upload_photo  %p#upload_progress Wysyłam pliki...  .progressbar    .progress  %p    %label Nazwa albumu    %br/    %input.name{ type: "text", name: "album[title]" }  %p    %label Opis    %br/    %textarea.description{ name: "album[description]" }');window.JST.new_status=('%form  %textarea{ name: "body", class: "status_body" }  %p Wpis na tablice podłączonych serwisów. Jego maksymalna długość nie powinna przekraczać 140 znaków. Linki są automatycznie skracane!');window.JST.notifications=(':each item in notifications  %a{ href: stream_path({ id: item.get("stream_id"), tab: "reactions" }) }= item.get("message")');window.JST.social_account=('.columns  .column.left    .block      %h2= account.escape("name")      %a{ href: "#" }.button.destroy Usuń  .column.right    .block      %h2 Statystyki      #stats');window.JST.social_accounts=('.columns  .column.left    .block      %h2 Z których serwisów korzystasz?      %p Dodaj serwisy na których mają być dodawane wpisy      %ul.navigation.features#providers        :each provider in providers          %li            %a.add_feature{ href: provider.url, data-basic_auth: provider.basic_auth, data-provider: provider.class } Dodaj serwis            %span{ class: provider.class }= provider.name             .description= provider.description      .clear    .block      %h2 Twój serwis      %p Token do wprowadzenia w twoim serwise wraz ze skryptem  .column.right    .block      %h2 Dodane serwisy      %ul.navigation.features        :if accounts.length == 0          %li Brak powiązanych serwisów        :each account in accounts          %li            %a.edit_feature{ href: social_account_path({ id: account.get("id") }) } Usuń serwis            %span{ class: account.get("type_name") }= account.escape("name")            .description= account.get("class_name")      .clear');window.JST.status=('.date  Dodany&nbsp  %abbr%h3 Wpis.clear.body= status.get("streamable")["body"].strip_tags().clear.tab.clear.progressbar  .progress%ul.views  %li    %a.urls{ href: "#" } Linki  %li    %a.reactions{ href: "#" } Reakcje  %li    %a.stats{ href: "#" } Statystyki.clear');window.JST.stream=('%a{ href: stream_path({ id: stream.get("id") }) }  .date    Dodany&nbsp    %abbr  = stream_partial');window.JST.stream_album=('%h3  Album.clear.description  %strong= stream.streamable.escape("title")  %br/  %span= stream.streamable.escape("description").thumbs  :each photo in stream.streamable.get("preview")    %img{ src: photo.thumb }.clear');window.JST.stream_details=('.block.details  .header    %ul.views      %li.urls        %a{ href: stream_path({ id: stream.get("id"), tab: "links" }), class: tabClass(tab, "links") } Linki      %li.reactions         %a{ href: stream_path({ id: stream.get("id"), tab: "reactions"}), class: tabClass(tab, "reactions") } Reakcje      %li.stats        %a{ href: stream_path({ id: stream.get("id"), tab: "stats"}), class: tabClass(tab, "stats") } Statystyki    .date      Dodany&nbsp      %abbr    .clear    .update{ class: stream.get("streamable_type").toLowerCase() }      = stream_partial    %hr/      .scroller');window.JST.stream_event=('%h3  Wydarzenie.clear.description  .flyaer    %img{ src: stream.streamable.get("thumb") }  .content    %strong= stream.streamable.escape("title")    %br/    %span      %strong Miejsce:&nbsp;      = stream.streamable.escape("where")    %br/    %span      %strong Godzina:&nbsp;      = stream.streamable.start_date()    %br/');window.JST.stream_links=('.status  %canvas{ width: "32px", height: "32px" }  %a.account{ href: social_account_path({ id: link.get(\'social_account\').id }) }= link.get("social_account").name  .description    :if link.pending()        %img{ src: "/images/pending.png" }        %strong Oczekuje na dodanie    :if link.error()      %img{ src: "/images/error.png" }      %span.error Nie można opublikować statusu... Ponowna próba będzie za chwile...    :if link.success()      %img{ src: "/images/success.png" }      Opublikowano, kliknij&nbsp;      %a{ href: "/links/"+link.get("id")} tutaj&nbsp;      aby zobaczyć ten wpis    :if link.working()      %img{ src: "/images/ajax.gif" }      Proszę czekać... Traw wysyłanie...');window.JST.stream_reaction=('%span= reaction.escape("message")');window.JST.stream_status=('%h3 Wpis.clear.body= stream.streamable.escape("body")')})();